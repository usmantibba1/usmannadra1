<!DOCTYPE html>
<html lang="ur" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¹Ø«Ù…Ø§Ù† Ù†Ø§Ø¯Ø±Ø§ Ø§ÛŒ Ø³ÛÙˆÙ„Øª â€” Ø¢Ù…Ø¯Ù†ÛŒ/Ø®Ø±Ú†Û/Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û/Ø§Ø¯Ú¾Ø§Ø±</title>

  <link href="https://fonts.googleapis.com/css2?family=Noto+Nastaliq+Urdu:wght@400;700&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg-main: linear-gradient(135deg,#e8f2ff,#f7fbff);
      --page-bg: rgba(255,255,255,0.98);
      --text: #17202a;
      --muted: #566074;
      --accent: #0b63d8;
      --income: #16a34a;
      --expense: #ef4444;
      --bank: #f59e0b;
      --udhar-taken: #0ea5e9;
      --udhar-given: #8b5cf6;
      --shop-expense: #d97706; /* Ù†Ø§Ø±Ù†Ø¬ÛŒ / Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û */
      --shadow: 0 8px 30px rgba(2,6,23,0.08);
      --glass-blur: none;
    }
    :root[data-theme="dark"]{
      --bg-main: linear-gradient(135deg,#0b1720,#071127);
      --page-bg: rgba(18,24,31,0.92);
      --text: #e6eef8;
      --muted: #9fb0c8;
      --accent: #059669;
      --income: #10b981;
      --expense: #f87171;
      --bank: #f59e0b;
      --udhar-taken: #38bdf8;
      --udhar-given: #a78bfa;
      --shop-expense: #f59e0b;
      --shadow: 0 8px 30px rgba(0,0,0,0.6);
    }
    *{ box-sizing:border-box; margin:0; padding:0; }
    html,body{ height:100%; font-family: 'Noto Nastaliq Urdu', serif; }
    body{
      min-height:100vh;
      background: var(--bg-main);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      padding:20px;
      display:flex; align-items:flex-start; justify-content:center;
    }
    .app{
      width:100%;
      max-width:1200px;
      margin:10px;
      background:var(--page-bg);
      border-radius:14px;
      box-shadow:var(--shadow);
      overflow:hidden;
      backdrop-filter: var(--glass-blur);
    }
    header{
      display:flex; align-items:center; justify-content:space-between;
      padding:14px 18px;
      background: linear-gradient(90deg, rgba(255,255,255,0.03), rgba(255,255,255,0.01));
    }
    header h1{ font-size:1.15rem; color:var(--text); display:flex; gap:12px; align-items:center; margin:0; }
    .brand{ display:flex; gap:10px; align-items:center; }
    .logo{ width:46px; height:46px; border-radius:8px; background:linear-gradient(135deg,#fff,#e6f0ff); display:flex; align-items:center; justify-content:center; font-weight:700; color:var(--accent); }

    .top-controls{ display:flex; gap:12px; align-items:center; }

    main{ display:grid; grid-template-columns:320px 1fr; gap:18px; padding:18px; }
    @media (max-width:980px){ main{ grid-template-columns:1fr; } }

    .sidebar{ padding:12px; border-radius:10px; background: rgba(255,255,255,0.85); box-shadow:0 6px 18px rgba(4,8,20,0.06); }
    :root[data-theme="dark"] .sidebar{ background: rgba(255,255,255,0.02); box-shadow:none; }

    .nav{ list-style:none; display:flex; flex-direction:column; gap:8px; margin-bottom:10px; }
    .nav a{ text-decoration:none; padding:10px; border-radius:8px; color:var(--text); display:block; }
    .nav a.active{ background:var(--accent); color:#fff; }

    .small { font-size:0.85rem; color:var(--muted); margin-top:8px; }

    .card{ background:linear-gradient(180deg, rgba(255,255,255,0.96), rgba(255,255,255,0.98)); padding:12px; border-radius:10px; margin-bottom:12px; box-shadow:0 4px 14px rgba(4,8,20,0.04); }
    :root[data-theme="dark"] .card{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); box-shadow: none; }

    .summary-grid{ display:grid; grid-template-columns:repeat(auto-fit,minmax(120px,1fr)); gap:10px; }
    .summary{ padding:10px; border-radius:8px; text-align:center; border-top:4px solid transparent; background:linear-gradient(180deg, rgba(255,255,255,0.85), rgba(255,255,255,0.95)); }
    :root[data-theme="dark"] .summary{ background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01)); }
    .summary h3{ font-size:0.92rem; color:var(--muted); margin-bottom:6px; }
    .summary p{ font-size:1.05rem; font-weight:700; margin:0; }

    .summary.income{ border-top-color:var(--income); }
    .summary.expense{ border-top-color:var(--expense); }
    .summary.balance{ border-top-color:var(--accent); }
    .summary.bank{ border-top-color:var(--bank); }
    .summary.udharTaken{ border-top-color:var(--udhar-taken); }
    .summary.udharGiven{ border-top-color:var(--udhar-given); }
    .summary.shopExpense{ border-top-color:var(--shop-expense); }

    form .row{ display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-top:8px; }
    @media (max-width:600px){ form .row{ grid-template-columns:1fr; } }

    input, select, textarea, button{
      padding:10px; border-radius:8px; border:1px solid rgba(0,0,0,0.06); font-size:0.95rem; width:100%;
      background:transparent; color:var(--text);
    }
    :root[data-theme="dark"] input, :root[data-theme="dark"] select, :root[data-theme="dark"] textarea{ border-color: rgba(255,255,255,0.06); }

    button{ background:var(--accent); color:#fff; border:none; cursor:pointer; }

    table{ width:100%; border-collapse:collapse; margin-top:10px; font-size:0.95rem; }
    th,td{ padding:10px; text-align:right; border-bottom:1px solid rgba(0,0,0,0.06); }
    :root[data-theme="dark"] th, :root[data-theme="dark"] td{ border-bottom:1px solid rgba(255,255,255,0.03); }
    th{ background:var(--accent); color:#fff; font-weight:normal; }

    .type-pill{ padding:6px 10px; border-radius:18px; color:#fff; font-weight:700; display:inline-block; min-width:100px; text-align:center; }
    .pill-income{ background:var(--income); }
    .pill-expense{ background:var(--expense); }
    .pill-bank{ background:var(--bank); }
    .pill-udharTaken{ background:var(--udhar-taken); }
    .pill-udharGiven{ background:var(--udhar-given); }
    .pill-shopExpense{ background:var(--shop-expense); }

    .row-income td{ background: linear-gradient(90deg, rgba(22,163,74,0.06), rgba(22,163,74,0.02)); }
    .row-expense td{ background: linear-gradient(90deg, rgba(239,68,68,0.06), rgba(239,68,68,0.02)); }
    .row-bank td{ background: linear-gradient(90deg, rgba(245,158,11,0.06), rgba(245,158,11,0.02)); }
    .row-udharTaken td{ background: linear-gradient(90deg, rgba(14,165,233,0.06), rgba(14,165,233,0.02)); }
    .row-udharGiven td{ background: linear-gradient(90deg, rgba(139,92,246,0.06), rgba(139,92,246,0.02)); }
    .row-shopExpense td{ background: linear-gradient(90deg, rgba(217,119,6,0.06), rgba(217,119,6,0.02)); }

    .controls{ display:flex; gap:8px; flex-wrap:wrap; align-items:center; }
    .icon-btn{ background:transparent; border:none; cursor:pointer; font-size:1.05rem; padding:6px; color:var(--text); }

    footer{ padding:10px 18px; text-align:center; color:var(--muted); font-size:0.9rem; }

    .hidden { display:none !important; }

    /* modal styles (simple) */
    .modal-backdrop{ position:fixed; inset:0; background:rgba(0,0,0,0.45); display:flex; align-items:center; justify-content:center; z-index:40; }
    .modal{ width:90%; max-width:760px; background:var(--page-bg); padding:14px; border-radius:10px; box-shadow:var(--shadow); }
    .modal h3{ margin-bottom:8px; }
    .modal .close{ float:left; background:transparent; border:none; font-size:1.2rem; cursor:pointer; }
    .mini-row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
    .calc-display{ width:100%; padding:12px; font-size:1.25rem; text-align:left; }
    .calc-keys{ display:grid; grid-template-columns:repeat(4,1fr); gap:8px; margin-top:8px; }
    .calc-keys button{ padding:10px; }
  </style>
</head>
<body>
  <div class="app" role="application" aria-label="Usman NADRA e-Sahulat">
    <header>
      <div class="brand">
        <div class="logo">N</div>
        <h1>Ø¹Ø«Ù…Ø§Ù† Ù†Ø§Ø¯Ø±Ø§ Ø§ÛŒ Ø³ÛÙˆÙ„Øª</h1>
      </div>

      <div class="top-controls">
        <label style="display:flex;align-items:center;gap:8px;">
          <input id="theme-toggle" type="checkbox" />
          <span class="small" id="theme-label">Light</span>
        </label>

        <div style="color:var(--muted);margin-right:6px">ØªÚ¾ÛŒÙ…</div>

        <div class="compact-row">
          <label><input id="compact-mode" type="checkbox"> Compact</label>
          <label style="margin-left:6px"><input id="blur-mode" type="checkbox"> Blur</label>
        </div>
        <button class="icon-btn" id="open-calculator" title="Calculator">ğŸ§®</button>
      </div>
    </header>

    <main>
      <aside class="sidebar">
        <nav>
          <ul class="nav">
            <li><a href="#" id="menu-daily" class="active">Ø±ÙˆØ²Ø§Ù†Û</a></li>
            <li><a href="#" id="menu-weekly">ÛÙØªÛ ÙˆØ§Ø±</a></li>
            <li><a href="#" id="menu-monthly">Ù…Ø§ÛØ§Ù†Û</a></li>
            <li><a href="#" id="menu-banks">Ø¨ÛŒÙ†Ú© Ø§Ú©Ø§Ø¤Ù†Ù¹Ø³</a></li>
            <li><a href="#" id="menu-udhar">Ø§Ø¯Ú¾Ø§Ø±</a></li>
          </ul>
        </nav>

        <div class="small">ØªÛŒØ² Ø±ÙØªØ§Ø± Ú©ÛŒÙ„Ø¦Û’ Compact Ø¢Ù† Ú©Ø±ÛŒÚºÛ”</div>
        <div style="margin-top:10px" class="controls">
          <button class="icon-btn" id="export-json" title="Export JSON">â¬‡ï¸</button>
          <button class="icon-btn" id="import-json" title="Import JSON">â¬†ï¸</button>
          <button class="icon-btn" id="clear-data" title="Clear Data">ğŸ—‘ï¸</button>
        </div>
      </aside>

      <section class="content">
        <!-- DAILY -->
        <section id="daily-section" class="card">
          <div style="display:flex; justify-content:space-between; align-items:center; gap:8px;">
            <h2>Ø¢Ø¬ Ú©Ø§ Ù…Ø¬Ù…ÙˆØ¹Û</h2>
            <div style="display:flex; gap:8px; align-items:center;">
              <label class="small">ØªØ§Ø±ÛŒØ® Ø¯ÛŒÚ©Ú¾ÛŒÚº:</label>
              <input type="date" id="view-date" />
              <button id="prev-day" class="icon-btn" title="Ù¾Ú†Ú¾Ù„Ø§ Ø¯Ù†">â—€</button>
              <button id="next-day" class="icon-btn" title="Ø§Ú¯Ù„Ø§ Ø¯Ù†">â–¶</button>
            </div>
          </div>

          <div class="summary-grid" style="margin-top:10px;">
            <div class="summary income"><h3>Ø¢Ù…Ø¯Ù†ÛŒ</h3><p id="today-income">0</p></div>
            <div class="summary expense"><h3>Ø®Ø±Ú†</h3><p id="today-expense">0</p></div>
            <div class="summary shopExpense"><h3>Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û</h3><p id="today-shop-expense">0</p></div>
            <div class="summary balance"><h3>Ø¨ÛŒÙ„Ù†Ø³</h3><p id="today-balance">0</p></div>
            <div class="summary bank"><h3>Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±</h3><p id="today-bank-transfer">0</p></div>
            <div class="summary udharTaken"><h3>Ø§Ø¯Ú¾Ø§Ø± Ù„ÛŒØ§</h3><p id="today-udhar-taken">0</p></div>
            <div class="summary udharGiven"><h3>Ø§Ø¯Ú¾Ø§Ø± Ø¯ÛŒØ§</h3><p id="today-udhar-given">0</p></div>
          </div>

          <div class="card" style="margin-top:12px;">
            <h3>Ù†ÛŒØ§ Ø±ÛŒÚ©Ø§Ø±Úˆ Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</h3>
            <form id="daily-form" style="margin-top:8px;">
              <div class="row">
                <div>
                  <label>Ø±Ù‚Ù…</label>
                  <input id="amount" type="number" required />
                </div>
                <div>
                  <label>Ù‚Ø³Ù…</label>
                  <select id="type">
                    <option value="income">Ø¢Ù…Ø¯Ù†ÛŒ</option>
                    <option value="expense">Ø®Ø±Ú†</option>
                    <option value="shop-expense">Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û</option>
                    <option value="bank-transfer">Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±</option>
                    <option value="udhar-taken">Ø§Ø¯Ú¾Ø§Ø± â€” Ù„ÛŒØ§</option>
                    <option value="udhar-given">Ø§Ø¯Ú¾Ø§Ø± â€” Ø¯ÛŒØ§</option>
                  </select>
                </div>
              </div>

              <div class="row" style="margin-top:8px;">
                <div id="bank-transfer-group" style="display:none;">
                  <label>Ø¨ÛŒÙ†Ú© Ø§Ú©Ø§Ø¤Ù†Ù¹</label>
                  <select id="bank-account"></select>
                </div>
                <div>
                  <label>ØªÙØµÛŒÙ„</label>
                  <textarea id="description" rows="1"></textarea>
                </div>
              </div>

              <div style="margin-top:10px; display:flex; gap:8px; align-items:center;">
                <button type="submit" class="small-btn">Ù…Ø­ÙÙˆØ¸ Ú©Ø±ÛŒÚº</button>
                <span id="type-badge" class="type-pill" style="background:transparent;color:#000"></span>
              </div>
            </form>
          </div>

          <div class="card" style="margin-top:12px;">
            <table id="daily-table" aria-live="polite">
              <thead>
                <tr><th>ÙˆÙ‚Øª</th><th>Ø±Ù‚Ù…</th><th>Ù‚Ø³Ù…</th><th>ØªÙØµÛŒÙ„</th><th>Ø¹Ù…Ù„</th></tr>
              </thead>
              <tbody id="daily-body"><tr><td colspan="5" style="text-align:center">Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- WEEKLY -->
        <section id="weekly-section" class="card" style="display:none;">
          <h2>ÛÙØªÛ ÙˆØ§Ø± Ø±Ù¾ÙˆØ±Ù¹</h2>
          <div class="summary-grid" style="margin-top:10px;">
            <div class="summary"><h3>ÛÙØªÛ’ Ú©ÛŒ Ø¢Ù…Ø¯Ù†ÛŒ</h3><p id="weekly-income">0</p></div>
            <div class="summary"><h3>ÛÙØªÛ’ Ú©Ø§ Ø®Ø±Ú†</h3><p id="weekly-expense">0</p></div>
            <div class="summary shopExpense"><h3>Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û</h3><p id="weekly-shop-expense">0</p></div>
            <div class="summary"><h3>ÛÙØªÛ’ Ú©Ø§ Ø¨ÛŒÙ„Ù†Ø³</h3><p id="weekly-balance">0</p></div>
            <div class="summary bank"><h3>Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±</h3><p id="weekly-bank-transfer">0</p></div>
          </div>

          <div class="card" style="margin-top:10px;">
            <table id="weekly-table">
              <thead><tr><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¢Ù…Ø¯Ù†ÛŒ</th><th>Ø®Ø±Ú†</th><th>Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û</th><th>Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±</th><th>Ø¨ÛŒÙ„Ù†Ø³</th></tr></thead>
              <tbody id="weekly-body"><tr><td colspan="6" style="text-align:center">Ø§Ø³ ÛÙØªÛ’ Ú©Ø§ Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- MONTHLY -->
        <section id="monthly-section" class="card" style="display:none;">
          <h2>Ù…Ø§ÛØ§Ù†Û Ø±Ù¾ÙˆØ±Ù¹</h2>
          <div class="summary-grid" style="margin-top:10px;">
            <div class="summary"><h3>Ù…Ø§Û Ú©ÛŒ Ø¢Ù…Ø¯Ù†ÛŒ</h3><p id="monthly-income">0</p></div>
            <div class="summary"><h3>Ù…Ø§Û Ú©Ø§ Ø®Ø±Ú†</h3><p id="monthly-expense">0</p></div>
            <div class="summary shopExpense"><h3>Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û</h3><p id="monthly-shop-expense">0</p></div>
            <div class="summary"><h3>Ù…Ø§Û Ú©Ø§ Ø¨ÛŒÙ„Ù†Ø³</h3><p id="monthly-balance">0</p></div>
            <div class="summary bank"><h3>Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±</h3><p id="monthly-bank-transfer">0</p></div>
          </div>

          <div class="card" style="margin-top:10px;">
            <table id="monthly-table">
              <thead><tr><th>ÛÙØªÛ</th><th>Ø¢Ù…Ø¯Ù†ÛŒ</th><th>Ø®Ø±Ú†</th><th>Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û</th><th>Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±</th><th>Ø¨ÛŒÙ„Ù†Ø³</th></tr></thead>
              <tbody id="monthly-body"><tr><td colspan="6" style="text-align:center">Ø§Ø³ Ù…Ø§Û Ú©Ø§ Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- BANKS -->
        <section id="banks-section" class="card" style="display:none;">
          <h2>Ø¨ÛŒÙ†Ú© Ø§Ú©Ø§Ø¤Ù†Ù¹Ø³</h2>

          <div class="summary-grid" style="margin-top:10px;">
            <div class="summary bank"><h3>Ú©Ù„ Ø¨ÛŒÙ„Ù†Ø³</h3><p id="total-bank-balance">0</p></div>
          </div>

          <form id="bank-form" style="margin-top:10px;">
            <div class="row">
              <div><label>Ø¨ÛŒÙ†Ú© Ú©Ø§ Ù†Ø§Ù…</label><input id="bank-name" type="text" required /></div>
              <div><label>Ø§Ø¨ØªØ¯Ø§Ø¦ÛŒ Ø¨ÛŒÙ„Ù†Ø³</label><input id="bank-balance" type="number" required /></div>
            </div>
            <div style="margin-top:8px;"><button type="submit">Ø¨ÛŒÙ†Ú© Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button></div>
          </form>

          <div class="card" style="margin-top:10px;">
            <table id="banks-table">
              <thead><tr><th>Ø¨ÛŒÙ†Ú© Ú©Ø§ Ù†Ø§Ù…</th><th>Ø¨ÛŒÙ„Ù†Ø³</th><th>Ø¹Ù…Ù„</th></tr></thead>
              <tbody id="banks-body"><tr><td colspan="3" style="text-align:center">Ú©ÙˆØ¦ÛŒ Ø¨ÛŒÙ†Ú© Ø§Ú©Ø§Ø¤Ù†Ù¹ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº</td></tr></tbody>
            </table>
          </div>
        </section>

        <!-- UDHAR -->
        <section id="udhar-section" class="card" style="display:none;">
          <h2>Ø§Ø¯Ú¾Ø§Ø± Ù…ÛŒÙ†Ø¬Ù…Ù†Ù¹</h2>

          <div class="card" style="margin-top:6px;">
            <h3>Ù†ÛŒØ§ Ø§Ø¯Ú¾Ø§Ø± Ø±ÛŒÚ©Ø§Ø±Úˆ</h3>
            <form id="udhar-form" style="margin-top:8px;">
              <div class="row">
                <div><label>Ú©Ø³ Ú©Ø§ Ù†Ø§Ù…</label><input id="udhar-name" type="text" required/></div>
                <div>
                  <label>Ù‚Ø³Ù…</label>
                  <select id="udhar-type">
                    <option value="taken">Ø§Ø¯Ú¾Ø§Ø± Ù„ÛŒØ§</option>
                    <option value="given">Ø§Ø¯Ú¾Ø§Ø± Ø¯ÛŒØ§</option>
                  </select>
                </div>
              </div>
              <div class="row" style="margin-top:8px;">
                <div><label>Ø±Ù‚Ù…</label><input id="udhar-amount" type="number" required/></div>
                <div><label>ØªØ§Ø±ÛŒØ® (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)</label><input id="udhar-date" type="date"/></div>
              </div>
              <div style="margin-top:8px;"><button type="submit">Ø§Ø¯Ú¾Ø§Ø± Ø´Ø§Ù…Ù„ Ú©Ø±ÛŒÚº</button></div>
            </form>
          </div>

          <div class="card" style="margin-top:10px;">
            <table id="udhar-table">
              <thead><tr><th>Ù†Ø§Ù…</th><th>Ù‚Ø³Ù…</th><th>Ø±Ù‚Ù…</th><th>ØªØ§Ø±ÛŒØ®</th><th>Ø¹Ù…Ù„</th></tr></thead>
              <tbody id="udhar-body"><tr><td colspan="5" style="text-align:center">Ú©ÙˆØ¦ÛŒ Ø§Ø¯Ú¾Ø§Ø± Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr></tbody>
            </table>
          </div>
        </section>

      </section>
    </main>

    <footer>Ù†Ø³Ø®Û Ù…Ø­ÙÙˆØ¸ â€” Ù…Ù‚Ø§Ù…ÛŒ Ø·ÙˆØ± Ù¾Ø± Ø¢Ù¾ Ú©Û’ Ø¨Ø±Ø§Ø¤Ø²Ø± Ù…ÛŒÚºÛ” Ù…Ø²ÛŒØ¯ ÙÛŒÚ†Ø±Ø² Ú©Û’ Ù„ÛŒÛ’ Ø¨ØªØ§Ø¦ÛŒÚºÛ”</footer>
  </div>

  <!-- Bank details modal -->
  <div id="bank-modal" class="hidden">
    <div class="modal-backdrop" id="bank-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <button class="close" id="close-bank-modal">âœ–</button>
        <h3 id="bank-modal-title">Ø¨ÛŒÙ†Ú© ÛØ³Ù¹Ø±ÛŒ</h3>
        <div class="mini-row">
          <label class="small">ØªØ§Ø±ÛŒØ®:</label>
          <input type="date" id="bank-view-date" />
          <button id="bank-prev" class="icon-btn">â—€</button>
          <button id="bank-next" class="icon-btn">â–¶</button>
        </div>
        <div style="margin-top:8px;">
          <table id="bank-trans-table">
            <thead><tr><th>ÙˆÙ‚Øª</th><th>Ø±Ù‚Ù…</th><th>ØªÙØµÛŒÙ„</th></tr></thead>
            <tbody id="bank-trans-body"><tr><td colspan="3" style="text-align:center">Ú©ÙˆØ¦ÛŒ Ù¹Ø±Ø§Ù†Ø²ÛŒÚ©Ø´Ù† Ù†ÛÛŒÚº</td></tr></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculator modal -->
  <div id="calc-modal" class="hidden">
    <div class="modal-backdrop" id="calc-backdrop">
      <div class="modal" role="dialog" aria-modal="true">
        <button class="close" id="close-calc">âœ–</button>
        <h3>Ú©ÛŒÙ„Ú©ÙˆÙ„ÛŒÙ¹Ø±</h3>
        <input id="calc-display" class="calc-display" readonly />
        <div class="calc-keys">
          <button data-key="7">7</button><button data-key="8">8</button><button data-key="9">9</button><button data-key="/">Ã·</button>
          <button data-key="4">4</button><button data-key="5">5</button><button data-key="6">6</button><button data-key="*">Ã—</button>
          <button data-key="1">1</button><button data-key="2">2</button><button data-key="3">3</button><button data-key="-">âˆ’</button>
          <button data-key="0">0</button><button data-key=".">.</button><button id="calc-eq">=</button><button data-key="+">+</button>
        </div>
        <div style="margin-top:8px; display:flex; gap:8px;">
          <button id="calc-clear">C</button><button id="calc-backspace">âŒ«</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ---------- Data ----------
    let dailyRecords = [];
    let weeklySummaries = [];
    let monthlySummaries = [];
    let banks = [];
    let udhars = [];

    const BANK_NAMES_PRESET = ["Ø§Ù„Ø­Ø¨ÛŒØ¨","Ù†Ø§Ø¯Ø±Ø§","Ù†Ù‚Ù„Ù ÙØ±Ø¯","Ø§ÙˆÙ…Ù†ÛŒ","Ø¬Ø§Ø² Ú©ÛŒØ´","Ø§ÛŒØ²ÛŒÙ¾ÛØ³Û","ÛŒÙˆ Ù¾ÛŒØ³Û (Ú¯Ù„Û’ Ù…ÛŒÚº)","ÛŒÙˆ Ø¨ÛŒ Ø§ÛŒÙ„"];
    const $ = id => document.getElementById(id);

    // ---------- Persistence ----------
    function saveData(){
      try{
        localStorage.setItem('usman_esahulat_v4', JSON.stringify({ dailyRecords, weeklySummaries, monthlySummaries, banks, udhars }));
      }catch(e){ console.warn('Could not save', e); }
    }

    function loadData(){
      const raw = localStorage.getItem('usman_esahulat_v4');
      if(raw){
        try{
          const data = JSON.parse(raw);
          dailyRecords = data.dailyRecords || [];
          weeklySummaries = data.weeklySummaries || [];
          monthlySummaries = data.monthlySummaries || [];
          banks = data.banks || [];
          udhars = data.udhars || [];
        }catch(err){
          dailyRecords = []; weeklySummaries=[]; monthlySummaries=[]; udhars=[];
          banks = BANK_NAMES_PRESET.map(name => ({ id: 'b'+Math.random().toString(36).slice(2,9), name, balance:0, transactions:[] }));
        }
      } else {
        banks = BANK_NAMES_PRESET.map(name => ({ id: 'b'+Math.random().toString(36).slice(2,9), name, balance:0, transactions:[] }));
      }
      renderAll();
      setDefaultViewDate();
    }

    // ---------- Render ----------
    function renderAll(){
      renderDaily();
      renderWeekly();
      renderMonthly();
      renderBanks();
      updateBankDropdown();
      renderUdhars();
    }

    // Use selected view date (so records don't disappear at midnight)
    function getSelectedViewDateKey(){
      const el = $('view-date');
      let d;
      if(el && el.value) d = new Date(el.value);
      else d = new Date();
      // format en-CA (YYYY-MM-DD)
      return d.toLocaleDateString('en-CA');
    }

    function renderDaily(){
      const todayKey = getSelectedViewDateKey();
      const todayRecords = dailyRecords.filter(r => r.date === todayKey).sort((a,b)=>b.timestamp-a.timestamp);

      const income = todayRecords.filter(r => r.type==='income').reduce((s,r)=>s+r.amount,0);
      const expense = todayRecords.filter(r => r.type==='expense').reduce((s,r)=>s+r.amount,0);
      const shopExpense = todayRecords.filter(r => r.type==='shop-expense').reduce((s,r)=>s+r.amount,0);
      const bankTransfer = todayRecords.filter(r => r.type==='bank-transfer').reduce((s,r)=>s+r.amount,0);
      const udharTaken = todayRecords.filter(r => r.type==='udhar-taken').reduce((s,r)=>s+r.amount,0);
      const udharGiven = todayRecords.filter(r => r.type==='udhar-given').reduce((s,r)=>s+r.amount,0);
      // Balance *should not* include shopExpense (as per request)
      const balance = income - expense;

      $('today-income').textContent = income.toLocaleString();
      $('today-expense').textContent = expense.toLocaleString();
      $('today-shop-expense').textContent = shopExpense.toLocaleString();
      $('today-bank-transfer').textContent = bankTransfer.toLocaleString();
      $('today-udhar-taken').textContent = udharTaken.toLocaleString();
      $('today-udhar-given').textContent = udharGiven.toLocaleString();
      $('today-balance').textContent = balance.toLocaleString();

      const tbody = $('daily-body');
      if(todayRecords.length===0){
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Ø§Ø³ ØªØ§Ø±ÛŒØ® Ú©Ø§ Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr>';
      } else {
        tbody.innerHTML = todayRecords.map(r=>{
          const cls = r.type==='income' ? 'row-income' : r.type==='expense' ? 'row-expense' : r.type==='bank-transfer' ? 'row-bank' : r.type==='udhar-taken' ? 'row-udharTaken' : r.type==='udhar-given' ? 'row-udharGiven' : 'row-shopExpense';
          const typeLabel = r.type==='income' ? 'Ø¢Ù…Ø¯Ù†ÛŒ' : r.type==='expense' ? 'Ø®Ø±Ú†' : r.type==='bank-transfer' ? 'Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±' : r.type==='udhar-taken' ? 'Ø§Ø¯Ú¾Ø§Ø± Ù„ÛŒØ§' : r.type==='udhar-given' ? 'Ø§Ø¯Ú¾Ø§Ø± Ø¯ÛŒØ§' : 'Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û';
          const pillClass = r.type==='income'?'pill-income':r.type==='expense'?'pill-expense':r.type==='bank-transfer'?'pill-bank':r.type==='udhar-taken'?'pill-udharTaken':r.type==='udhar-given'?'pill-udharGiven':'pill-shopExpense';
          return `<tr class="${cls}">
            <td>${new Date(r.timestamp).toLocaleTimeString('ur-PK')}</td>
            <td>${r.amount.toLocaleString()}</td>
            <td><span class="type-pill ${pillClass}">${typeLabel}</span></td>
            <td>${r.description || '-' } ${r.bankName ? '('+r.bankName +')' : ''}</td>
            <td><button class="icon-btn" onclick="deleteDailyRecord('${r.id}')">âŒ</button></td>
          </tr>`;
        }).join('');
      }
    }

    function renderWeekly(){
      const nowWeek = getCurrentWeekNumber();
      const week = weeklySummaries.find(w=>w.week===nowWeek) || { income:0,expense:0,bankTransfer:0,shopExpense:0 };
      $('weekly-income').textContent = (week.income||0).toLocaleString();
      $('weekly-expense').textContent = (week.expense||0).toLocaleString();
      $('weekly-shop-expense').textContent = (week.shopExpense||0).toLocaleString();
      $('weekly-bank-transfer').textContent = (week.bankTransfer||0).toLocaleString();
      $('weekly-balance').textContent = ((week.income||0)-(week.expense||0)).toLocaleString();

      const weekStart = getStartOfWeek();
      const weekRecords = dailyRecords.filter(r => new Date(r.timestamp) >= weekStart);
      const dailyMap = {};
      weekRecords.forEach(r=>{
        if(!dailyMap[r.date]) dailyMap[r.date]={income:0,expense:0,bankTransfer:0,shopExpense:0};
        if(r.type==='income') dailyMap[r.date].income += r.amount;
        else if(r.type==='expense') dailyMap[r.date].expense += r.amount;
        else if(r.type==='bank-transfer') dailyMap[r.date].bankTransfer += r.amount;
        else if(r.type==='shop-expense') dailyMap[r.date].shopExpense += r.amount;
      });

      const tbody = $('weekly-body');
      const keys = Object.keys(dailyMap).sort();
      if(keys.length===0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Ø§Ø³ ÛÙØªÛ’ Ú©Ø§ Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr>';
      else tbody.innerHTML = keys.map(d=>{
        const day = dailyMap[d];
        return `<tr>
          <td>${new Date(d).toLocaleDateString('ur-PK')}</td>
          <td>${(day.income||0).toLocaleString()}</td>
          <td>${(day.expense||0).toLocaleString()}</td>
          <td>${(day.shopExpense||0).toLocaleString()}</td>
          <td>${(day.bankTransfer||0).toLocaleString()}</td>
          <td>${((day.income||0)-(day.expense||0)).toLocaleString()}</td>
        </tr>`;
      }).join('');
    }

    function renderMonthly(){
      const now = new Date();
      const key = `${now.getFullYear()}-${now.getMonth()+1}`;
      const m = monthlySummaries.find(m=>m.month===key) || { income:0,expense:0,bankTransfer:0,shopExpense:0 };
      $('monthly-income').textContent = (m.income||0).toLocaleString();
      $('monthly-expense').textContent = (m.expense||0).toLocaleString();
      $('monthly-shop-expense').textContent = (m.shopExpense||0).toLocaleString();
      $('monthly-bank-transfer').textContent = (m.bankTransfer||0).toLocaleString();
      $('monthly-balance').textContent = ((m.income||0)-(m.expense||0)).toLocaleString();

      const tbody = $('monthly-body');
      const weeks = weeklySummaries.filter(w=>{
        const d = new Date(w.timestamp||Date.now());
        return d.getFullYear()===now.getFullYear() && (d.getMonth()+1)=== (now.getMonth()+1);
      }).sort((a,b)=>a.week-b.week);
      if(weeks.length===0) tbody.innerHTML = '<tr><td colspan="6" style="text-align:center">Ø§Ø³ Ù…Ø§Û Ú©Ø§ Ú©ÙˆØ¦ÛŒ Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr>';
      else tbody.innerHTML = weeks.map(w=>`<tr><td>ÛÙØªÛ ${w.week}</td><td>${(w.income||0).toLocaleString()}</td><td>${(w.expense||0).toLocaleString()}</td><td>${(w.shopExpense||0).toLocaleString()}</td><td>${(w.bankTransfer||0).toLocaleString()}</td><td>${((w.income||0)-(w.expense||0)).toLocaleString()}</td></tr>`).join('');
    }

    function renderBanks(){
      $('total-bank-balance').textContent = banks.reduce((s,b)=>s+(b.balance||0),0).toLocaleString();
      const tbody = $('banks-body');
      if(banks.length===0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Ú©ÙˆØ¦ÛŒ Ø¨ÛŒÙ†Ú© Ø§Ú©Ø§Ø¤Ù†Ù¹ Ù…ÙˆØ¬ÙˆØ¯ Ù†ÛÛŒÚº</td></tr>';
      else tbody.innerHTML = banks.map(b=>`<tr><td>${b.name}</td><td>${(b.balance||0).toLocaleString()}</td><td><button class="icon-btn" onclick="showBankDetails('${b.id}')">ğŸ“‘</button><button class="icon-btn" onclick="editBank('${b.id}')">âœï¸</button><button class="icon-btn" onclick="deleteBank('${b.id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
    }

    function updateBankDropdown(){
      const sel = $('bank-account');
      if(!sel) return;
      if(banks.length===0) sel.innerHTML = '<option value="">Ú©ÙˆØ¦ÛŒ Ø¨ÛŒÙ†Ú© Ù†ÛÛŒÚº</option>';
      else sel.innerHTML = banks.map(b=>`<option value="${b.id}">${b.name} (${(b.balance||0).toLocaleString()})</option>`).join('');
    }

    function renderUdhars(){
      const tbody = $('udhar-body');
      if(udhars.length===0) tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Ú©ÙˆØ¦ÛŒ Ø§Ø¯Ú¾Ø§Ø± Ø±ÛŒÚ©Ø§Ø±Úˆ Ù†ÛÛŒÚº</td></tr>';
      else tbody.innerHTML = udhars.map(u=>`<tr><td>${u.name}</td><td>${u.type==='taken'?'Ø§Ø¯Ú¾Ø§Ø± Ù„ÛŒØ§':'Ø§Ø¯Ú¾Ø§Ø± Ø¯ÛŒØ§'}</td><td>${u.amount.toLocaleString()}</td><td>${u.date||''}</td><td><button class="icon-btn" onclick="deleteUdhar('${u.id}')">ğŸ—‘ï¸</button></td></tr>`).join('');
    }

    // ---------- Helpers ----------
    function getCurrentWeekNumber(){
      const now = new Date();
      const start = new Date(now.getFullYear(),0,1);
      const diff = Math.floor((now - start) / 86400000);
      return Math.ceil((diff + start.getDay()+1)/7);
    }
    function getStartOfWeek(){
      const now = new Date();
      const day = now.getDay();
      const diff = now.getDate() - day;
      return new Date(now.getFullYear(), now.getMonth(), diff);
    }

    function setDefaultViewDate(){
      const el = $('view-date');
      if(!el) return;
      const today = new Date();
      el.value = today.toISOString().slice(0,10);
      // bank modal view default
      const bd = $('bank-view-date'); if(bd) bd.value = today.toISOString().slice(0,10);
    }

    function shiftViewDate(days){
      const el = $('view-date'); if(!el) return;
      const d = el.value ? new Date(el.value) : new Date();
      d.setDate(d.getDate() + days);
      el.value = d.toISOString().slice(0,10);
      renderDaily();
    }

    // ---------- Forms ----------
    $('daily-form').addEventListener('submit', function(e){
      e.preventDefault();
      const amt = parseFloat($('amount').value);
      const type = $('type').value;
      const desc = $('description').value || '';
      if(!amt || isNaN(amt)){ alert('Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø±Ù‚Ù… Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº'); return; }
      const selectedDateInput = $('view-date').value;
      const now = selectedDateInput ? new Date(selectedDateInput + 'T' + (new Date()).toTimeString().split(' ')[0]) : new Date();
      const rec = {
        id: 'r'+Date.now().toString(36),
        date: now.toLocaleDateString('en-CA'),
        timestamp: now.getTime(),
        amount: amt,
        type,
        description: desc,
        week: getCurrentWeekNumber(),
        month: `${now.getFullYear()}-${now.getMonth()+1}`
      };
      if(type==='bank-transfer'){
        const bankId = $('bank-account').value;
        const bank = banks.find(b=>b.id===bankId);
        if(!bank){ alert('Ø¨Ø±Ø§Û Ú©Ø±Ù… Ø¨ÛŒÙ†Ú© Ù…Ù†ØªØ®Ø¨ Ú©Ø±ÛŒÚº'); return; }
        rec.bankId = bankId;
        rec.bankName = bank.name;
        bank.balance = (bank.balance||0) + amt;
        if(!Array.isArray(bank.transactions)) bank.transactions = [];
        bank.transactions.push({ id: 't'+Date.now().toString(36), date: rec.date, timestamp: rec.timestamp, amount: amt, description: desc || 'Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±' });
      }
      if(type==='udhar-taken' || type==='udhar-given'){
        const u = {
          id: 'u'+Date.now().toString(36),
          name: desc || 'Ù†Ø§Ù… ØºÛŒØ± Ù…Ø¹Ù„ÙˆÙ…',
          type: type==='udhar-taken' ? 'taken' : 'given',
          amount: amt,
          date: new Date().toLocaleDateString('en-CA')
        };
        udhars.push(u);
      }
      dailyRecords.push(rec);
      updateSummariesOnAdd(rec);
      saveData();
      renderAll();
      this.reset();
      $('type-badge').textContent='';
    });

    $('type').addEventListener('change', function(){
      const v = this.value;
      const badge = $('type-badge');
      if(v==='income'){ badge.textContent='Ø¢Ù…Ø¯Ù†ÛŒ'; badge.className='type-pill pill-income'; $('bank-transfer-group').style.display='none'; }
      else if(v==='expense'){ badge.textContent='Ø®Ø±Ú†'; badge.className='type-pill pill-expense'; $('bank-transfer-group').style.display='none'; }
      else if(v==='shop-expense'){ badge.textContent='Ø¯Ú©Ø§Ù† Ø®Ø±Ú†Û'; badge.className='type-pill pill-shopExpense'; $('bank-transfer-group').style.display='none'; }
      else if(v==='bank-transfer'){ badge.textContent='Ø¨ÛŒÙ†Ú© Ù¹Ø±Ø§Ù†Ø³ÙØ±'; badge.className='type-pill pill-bank'; $('bank-transfer-group').style.display='block'; }
      else if(v==='udhar-taken'){ badge.textContent='Ø§Ø¯Ú¾Ø§Ø± Ù„ÛŒØ§'; badge.className='type-pill pill-udharTaken'; $('bank-transfer-group').style.display='none'; }
      else { badge.textContent='Ø§Ø¯Ú¾Ø§Ø± Ø¯ÛŒØ§'; badge.className='type-pill pill-udharGiven'; $('bank-transfer-group').style.display='none'; }
    });

    // bank form
    $('bank-form').addEventListener('submit', function(e){
      e.preventDefault();
      const name = $('bank-name').value.trim();
      const bal = parseFloat($('bank-balance').value);
      if(!name || isNaN(bal)){ alert('Ø¯Ø±Ø³Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº'); return; }
      banks.push({ id:'b'+Date.now().toString(36), name, balance:bal, transactions:[{ id:'t'+Date.now().toString(36), date:new Date().toLocaleDateString('en-CA'), timestamp:Date.now(), amount:bal, description:'Ø§Ø¨ØªØ¯Ø§Ø¦ÛŒ Ø¨ÛŒÙ„Ù†Ø³' }] });
      saveData(); renderAll(); this.reset();
    });

    // udhar form
    $('udhar-form').addEventListener('submit', function(e){
      e.preventDefault();
      const name = $('udhar-name').value.trim();
      const type = $('udhar-type').value;
      const amount = parseFloat($('udhar-amount').value);
      const date = $('udhar-date').value || new Date().toLocaleDateString('en-CA');
      if(!name || isNaN(amount)){ alert('Ø¯Ø±Ø³Øª Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº'); return; }
      udhars.push({ id:'u'+Date.now().toString(36), name, type, amount, date });
      saveData(); renderUdhars(); this.reset();
    });

    // delete/edit
    window.deleteDailyRecord = function(id){
      if(!confirm('Ú©ÛŒØ§ Ø­Ø°Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ')) return;
      const idx = dailyRecords.findIndex(r=>r.id===id);
      if(idx===-1) return;
      const rec = dailyRecords[idx];
      if(rec.type==='bank-transfer' && rec.bankId){
        const b = banks.find(x=>x.id===rec.bankId);
        if(b){ b.balance -= rec.amount;
          if(Array.isArray(b.transactions)){
            b.transactions = b.transactions.filter(t => !(t.timestamp===rec.timestamp && t.amount===rec.amount));
          }
        }
      }
      updateSummariesOnDelete(rec);
      dailyRecords.splice(idx,1);
      saveData(); renderAll();
    };

    window.deleteBank = function(id){
      if(!confirm('Ú©ÛŒØ§ ÙˆØ§Ù‚Ø¹ÛŒ Ø¨ÛŒÙ†Ú© ÛÙ¹Ø§Ù†Ø§ ÛÛ’ØŸ')) return;
      dailyRecords = dailyRecords.map(r=> r.bankId===id ? {...r, bankId:null, bankName:'(Ø­Ø°Ù Ø´Ø¯Û Ø¨ÛŒÙ†Ú©)'} : r);
      banks = banks.filter(b=>b.id!==id);
      saveData(); renderAll();
    };

    window.editBank = function(id){
      const b = banks.find(x=>x.id===id);
      if(!b) return;
      const val = prompt('Ù†ÛŒØ§ Ø¨ÛŒÙ„Ù†Ø³ Ø¯Ø±Ø¬ Ú©Ø±ÛŒÚº: ' + b.name, b.balance||0);
      if(val!==null && !isNaN(parseFloat(val))){ b.balance = parseFloat(val); saveData(); renderAll(); }
    };

    window.deleteUdhar = function(id){
      if(!confirm('Ú©ÛŒØ§ ÙˆØ§Ù‚Ø¹ÛŒ Ø§Ø¯Ú¾Ø§Ø± Ø±ÛŒÚ©Ø§Ø±Úˆ ÛÙ¹Ø§Ù†Ø§ ÛÛ’ØŸ')) return;
      udhars = udhars.filter(u=>u.id!==id);
      saveData(); renderUdhars();
    };

    // summaries update
    function updateSummariesOnAdd(rec){
      let week = weeklySummaries.find(w=>w.week===rec.week);
      if(!week){ week = { week: rec.week, income:0, expense:0, bankTransfer:0, shopExpense:0, timestamp: Date.now() }; weeklySummaries.push(week); }
      if(rec.type==='income') week.income += rec.amount;
      else if(rec.type==='expense') week.expense += rec.amount;
      else if(rec.type==='bank-transfer') week.bankTransfer += rec.amount;
      else if(rec.type==='shop-expense') week.shopExpense += rec.amount;

      let month = monthlySummaries.find(m=>m.month===rec.month);
      if(!month){ month = { month: rec.month, income:0, expense:0, bankTransfer:0, shopExpense:0, timestamp: Date.now() }; monthlySummaries.push(month); }
      if(rec.type==='income') month.income += rec.amount;
      else if(rec.type==='expense') month.expense += rec.amount;
      else if(rec.type==='bank-transfer') month.bankTransfer += rec.amount;
      else if(rec.type==='shop-expense') month.shopExpense += rec.amount;
    }

    function updateSummariesOnDelete(rec){
      const w = weeklySummaries.find(x=>x.week===rec.week);
      if(w){
        if(rec.type==='income') w.income -= rec.amount;
        else if(rec.type==='expense') w.expense -= rec.amount;
        else if(rec.type==='bank-transfer') w.bankTransfer -= rec.amount;
        else if(rec.type==='shop-expense') w.shopExpense -= rec.amount;
        if((w.income||0)+(w.expense||0)+(w.bankTransfer||0)+(w.shopExpense||0)===0) weeklySummaries = weeklySummaries.filter(x=>x.week!==rec.week);
      }
      const m = monthlySummaries.find(x=>x.month===rec.month);
      if(m){
        if(rec.type==='income') m.income -= rec.amount;
        else if(rec.type==='expense') m.expense -= rec.amount;
        else if(rec.type==='bank-transfer') m.bankTransfer -= rec.amount;
        else if(rec.type==='shop-expense') m.shopExpense -= rec.amount;
        if((m.income||0)+(m.expense||0)+(m.bankTransfer||0)+(m.shopExpense||0)===0) monthlySummaries = monthlySummaries.filter(x=>x.month!==rec.month);
      }
    }

    // navigation
    function showSection(id){
      ['daily','weekly','monthly','banks','udhar'].forEach(s=>{
        const el = document.getElementById(s+'-section');
        if(el) el.style.display = (s===id ? 'block' : 'none');
        const link = document.getElementById('menu-'+s);
        if(link) link.classList.toggle('active', s===id);
      });
    }
    $('menu-daily').addEventListener('click', e=>{ e.preventDefault(); showSection('daily'); });
    $('menu-weekly').addEventListener('click', e=>{ e.preventDefault(); showSection('weekly'); });
    $('menu-monthly').addEventListener('click', e=>{ e.preventDefault(); showSection('monthly'); });
    $('menu-banks').addEventListener('click', e=>{ e.preventDefault(); showSection('banks'); });
    $('menu-udhar').addEventListener('click', e=>{ e.preventDefault(); showSection('udhar'); });

    // ---------- Theme logic ----------
    const THEMES = {
      light: { name:'light', accent:'#0b6ef6', bg:'linear-gradient(135deg,#e8f2ff,#f7fbff)', card:'#ffffff' },
      dark: { name:'dark', accent:'#059669', bg:'linear-gradient(135deg,#0b1720,#071127)', card:'rgba(18,24,31,0.92)' }
    };

    function applyThemeByName(name){
      if(name==='dark'){
        document.documentElement.setAttribute('data-theme','dark');
        $('theme-toggle').checked = true;
        $('theme-label').textContent = 'Dark';
      } else {
        document.documentElement.removeAttribute('data-theme');
        $('theme-toggle').checked = false;
        $('theme-label').textContent = 'Light';
      }
      localStorage.setItem('esahulat_theme_v4', JSON.stringify(name));
    }

    $('compact-mode').addEventListener('change', function(){
      if(this.checked) document.documentElement.setAttribute('data-compact','true');
      else document.documentElement.removeAttribute('data-compact');
      localStorage.setItem('esahulat_compact_v4', this.checked ? '1' : '0');
    });
    $('blur-mode').addEventListener('change', function(){
      if(this.checked) document.documentElement.style.setProperty('--glass-blur','blur(10px)');
      else document.documentElement.style.setProperty('--glass-blur','none');
      localStorage.setItem('esahulat_blur_v4', this.checked ? '1' : '0');
    });

    function loadPrefs(){
      const t = localStorage.getItem('esahulat_theme_v4');
      if(t){
        try{
          const name = JSON.parse(t);
          applyThemeByName(name);
        }catch(e){ applyThemeByName('light'); }
      } else {
        applyThemeByName('light');
      }

      const c = localStorage.getItem('esahulat_compact_v4'); if(c==='1'){ $('compact-mode').checked = true; document.documentElement.setAttribute('data-compact','true'); }
      const b = localStorage.getItem('esahulat_blur_v4'); if(b==='1'){ $('blur-mode').checked = true; document.documentElement.style.setProperty('--glass-blur','blur(10px)'); }
    }

    $('theme-toggle').addEventListener('change', function(){ applyThemeByName(this.checked ? 'dark' : 'light'); });

    // ---------- Export/Import/Clear ----------
    $('export-json').addEventListener('click', ()=>{
      const data = JSON.stringify({ dailyRecords, weeklySummaries, monthlySummaries, banks, udhars }, null, 2);
      const blob = new Blob([data],{type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'usman_esahulat_backup.json'; a.click(); URL.revokeObjectURL(url);
    });

    $('import-json').addEventListener('click', ()=>{
      const input = document.createElement('input'); input.type='file'; input.accept='application/json';
      input.onchange = e => {
        const f = e.target.files[0]; if(!f) return;
        const reader = new FileReader();
        reader.onload = ev => {
          try{
            const obj = JSON.parse(ev.target.result);
            dailyRecords = obj.dailyRecords || dailyRecords;
            weeklySummaries = obj.weeklySummaries || weeklySummaries;
            monthlySummaries = obj.monthlySummaries || monthlySummaries;
            banks = obj.banks || banks;
            udhars = obj.udhars || udhars;
            saveData(); renderAll(); alert('ÚˆÛŒÙ¹Ø§ Ø§Ù…Ù¾ÙˆØ±Ù¹ ÛÙˆ Ú¯ÛŒØ§');
          }catch(err){ alert('ÙØ§Ø¦Ù„ Ù¾Ú‘Ú¾Ù†Û’ Ù…ÛŒÚº Ù…Ø³Ø¦Ù„Û'); }
        };
        reader.readAsText(f);
      };
      input.click();
    });

    $('clear-data').addEventListener('click', ()=>{
      if(!confirm('Ú©ÛŒØ§ Ø¢Ù¾ Ø³Ø§Ø±Ø§ Ù…Ù‚Ø§Ù…ÛŒ ÚˆÛŒÙ¹Ø§ ØµØ§Ù Ú©Ø±Ù†Ø§ Ú†Ø§ÛØªÛ’ ÛÛŒÚºØŸ')) return;
      localStorage.removeItem('usman_esahulat_v4');
      dailyRecords=[]; weeklySummaries=[]; monthlySummaries=[]; banks=[]; udhars=[];
      banks = BANK_NAMES_PRESET.map(name => ({ id: 'b'+Math.random().toString(36).slice(2,9), name, balance:0, transactions:[] }));
      saveData(); renderAll();
    });

    // ---------- Bank details modal logic ----------
    function showBankDetails(bankId){
      const bank = banks.find(b=>b.id===bankId);
      if(!bank) return;
      const modalWrap = $('bank-modal');
      const title = $('bank-modal-title');
      title.textContent = bank.name + ' â€” ÛØ³Ù¹Ø±ÛŒ';
      modalWrap.classList.remove('hidden');
      const bd = $('bank-view-date'); if(bd && !bd.value) bd.value = new Date().toISOString().slice(0,10);
      renderBankTransactions(bankId);
      modalWrap.dataset.bankId = bankId;
    }
    function closeBankModal(){ const modalWrap = $('bank-modal'); modalWrap.classList.add('hidden'); modalWrap.dataset.bankId=''; }
    $('close-bank-modal').addEventListener('click', closeBankModal);
    $('bank-backdrop').addEventListener('click', function(e){ if(e.target === this) closeBankModal(); });

    function renderBankTransactions(bankId){
      const bank = banks.find(b=>b.id===bankId);
      if(!bank) return;
      const dateFilter = $('bank-view-date').value;
      let trans = Array.isArray(bank.transactions) ? bank.transactions.slice().sort((a,b)=>b.timestamp-a.timestamp) : [];
      if(dateFilter){
        const key = new Date(dateFilter).toLocaleDateString('en-CA');
        trans = trans.filter(t=>t.date===key);
      }
      const tbody = $('bank-trans-body');
      if(trans.length===0) tbody.innerHTML = '<tr><td colspan="3" style="text-align:center">Ú©ÙˆØ¦ÛŒ Ù¹Ø±Ø§Ù†Ø²ÛŒÚ©Ø´Ù† Ù†ÛÛŒÚº</td></tr>';
      else tbody.innerHTML = trans.map(t=>`<tr><td>${new Date(t.timestamp).toLocaleTimeString('ur-PK')}</td><td>${t.amount.toLocaleString()}</td><td>${t.description||''}</td></tr>`).join('');
    }
    $('bank-view-date').addEventListener('change', ()=>{ const id = $('bank-modal').dataset.bankId; if(id) renderBankTransactions(id); });
    $('bank-prev').addEventListener('click', ()=>{ shiftBankModalDate(-1); });
    $('bank-next').addEventListener('click', ()=>{ shiftBankModalDate(1); });
    function shiftBankModalDate(days){
      const el = $('bank-view-date'); if(!el) return;
      const d = el.value ? new Date(el.value) : new Date();
      d.setDate(d.getDate() + days);
      el.value = d.toISOString().slice(0,10);
      const id = $('bank-modal').dataset.bankId; if(id) renderBankTransactions(id);
    }

    // ---------- Init ----------
    loadPrefs();
    loadData();
    setInterval(()=>{ renderAll(); }, 30000);
    if($('type')) $('type').dispatchEvent(new Event('change'));

    // view-date controls (so daily records don't vanish at midnight)
    $('view-date').addEventListener('change', renderDaily);
    $('prev-day').addEventListener('click', ()=>shiftViewDate(-1));
    $('next-day').addEventListener('click', ()=>shiftViewDate(1));

    // ---------- bank modal prev/next via daily arrows ----------
    $('prev-day').addEventListener('click', ()=>{ /* already handled above */ });
    $('next-day').addEventListener('click', ()=>{ /* already handled above */ });

    // ---------- bank modal close on escape ----------
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ if(!$('bank-modal').classList.contains('hidden')) closeBankModal(); if(!$('calc-modal').classList.contains('hidden')) closeCalc(); } });

    // ---------- Calculator logic ----------
    const calcModal = $('calc-modal');
    const calcDisplay = $('calc-display');
    const calcKeys = Array.from(document.querySelectorAll('.calc-keys button'));
    document.getElementById('open-calculator').addEventListener('click', ()=>{ calcModal.classList.remove('hidden'); if(calcDisplay) calcDisplay.value=''; });
    document.getElementById('close-calc').addEventListener('click', closeCalc);
    document.getElementById('calc-clear').addEventListener('click', ()=>{ calcDisplay.value=''; });
    document.getElementById('calc-backspace').addEventListener('click', ()=>{ calcDisplay.value = calcDisplay.value.slice(0,-1); });
    calcKeys.forEach(b=>{
      b.addEventListener('click', ()=>{ const k = b.dataset.key; if(k) calcDisplay.value += k; });
    });
    document.getElementById('calc-eq').addEventListener('click', ()=>{ evaluateCalc(); });

    function evaluateCalc(){
      try{
        const expr = calcDisplay.value.replace(/Ã—/g,'*').replace(/Ã·/g,'/');
        if(!/^[0-9+\-*/().\s]+$/.test(expr)) { alert('Invalid expression'); return; }
        const res = Function('"use strict"; return ('+expr+')')();
        calcDisplay.value = (typeof res === 'number' && isFinite(res)) ? res.toString() : 'Error';
      }catch(e){ calcDisplay.value = 'Error'; }
    }

    function closeCalc(){ calcModal.classList.add('hidden'); }

    // click outside modals to close
    $('calc-backdrop').addEventListener('click', function(e){ if(e.target === this) closeCalc(); });

  </script>
<!-- ===== Welcome popup (paste before </body>) ===== -->
<div id="welcome-modal">
  <div class="modal-backdrop" id="welcome-backdrop" style="display:flex;align-items:center;justify-content:center;">
    <div class="modal" role="dialog" aria-modal="true" style="text-align:center;">
      <button class="close" id="close-welcome">âœ–</button>
      <h3 style="font-size:1.4rem; margin-top:6px;">Ø¨ÙØ³Ù’Ù…Ù Ø§Ù„Ù„ÛÙ Ø§Ù„Ø±ÙÙ‘Ø­Ù’Ù…Ù°Ù†Ù Ø§Ù„Ø±ÙÙ‘Ø­ÙÛŒÙ’Ù…</h3>
      <p id="welcome-name" style="font-size:1.25rem; margin-top:8px; font-weight:700;">Ø§Ø³Ù… â€” Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯</p>
      <div style="margin-top:10px;">
        <button id="welcome-ok" style="padding:8px 14px; border-radius:8px; border:none; background:var(--accent); color:#fff; cursor:pointer;">Ù¹Ú¾ÛŒÚ© ÛÛ’</button>
      </div>
    </div>
  </div>
</div>

<script>
  (function(){
    const WELCOME_NAME = 'Ø¹Ø«Ù…Ø§Ù†'; // <-- Ø§Ù¾Ù†ÛŒ Ù…Ø±Ø¶ÛŒ Ú©Ø§ Ù†Ø§Ù… ÛŒÛØ§Úº Ù„Ú©Ú¾ÛŒÚº

    const modalWrap = document.getElementById('welcome-modal');
    const nameEl = document.getElementById('welcome-name');
    const closeBtn = document.getElementById('close-welcome');
    const okBtn = document.getElementById('welcome-ok');
    const backdrop = document.getElementById('welcome-backdrop');

    if(nameEl) nameEl.textContent = `${WELCOME_NAME} â€” Ø®ÙˆØ´ Ø¢Ù…Ø¯ÛŒØ¯`;
    if(modalWrap) modalWrap.classList.remove('hidden');

    function closeWelcome(){ if(modalWrap) modalWrap.classList.add('hidden'); }
    closeBtn && closeBtn.addEventListener('click', closeWelcome);
    okBtn && okBtn.addEventListener('click', closeWelcome);
    backdrop && backdrop.addEventListener('click', function(e){ if(e.target === this) closeWelcome(); });
    window.addEventListener('keydown', function(e){ if(e.key === 'Escape') closeWelcome(); });
  })();
</script>
<!-- ===== end welcome popup ===== -->

</body>
</html>
